<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pragati - Digital Labour Haat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://rsms.me/">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

  <style>
    :root {
      --pragati-primary: #349674;
      --pragati-primary-dark: #2a7d62;
      --pragati-red: #dc2626;
      --background-cream: #FDF8F2;
      --text-dark: #374151;
      --gray-border: #d1d5db;
      font-family: 'Inter', sans-serif;
    }
    body { 
        background-color: var(--background-cream);
        color: var(--text-dark);
        overflow-x: hidden;
        overflow-y: auto;
    }
    #bg-video-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -2;
        overflow: hidden;
    }
    #bg-video {
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    #video-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(253, 248, 242, 0.85); /* Cream overlay */
        z-index: -1;
    }
    .card { 
        background-color: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 0.75rem; 
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        border: 1px solid var(--gray-border);
        padding: 1.5rem; 
    }
    .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; border: 1px solid transparent; cursor: pointer; }
    .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
    .btn-primary { background-color: var(--pragati-primary); color: white; }
    .btn-primary:hover:not(:disabled) { background-color: var(--pragati-primary-dark); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(52, 150, 116, 0.3); }
    .btn-danger { background-color: var(--pragati-red); color: white; }
    .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }
    .btn-secondary { background-color: white; color: var(--text-dark); border-color: var(--gray-border); }
    .btn-secondary:hover { background-color: #f9fafb; }
    .form-input { 
        width: 100%; 
        padding: 0.75rem 1rem; 
        border: 1px solid var(--gray-border); 
        border-radius: 0.5rem; 
        transition: all 0.2s ease-in-out;
        background-color: #f9fafb;
        color: var(--text-dark);
    }
    .form-input::placeholder { color: #9ca3af; }
    .form-input:focus { outline: none; border-color: var(--pragati-primary); box-shadow: 0 0 0 3px rgba(52, 150, 116, 0.2); }
    .skill-icon { border: 2px solid var(--gray-border); transition: all 0.2s ease; background-color: #f9fafb; }
    .skill-icon:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: #72c4aa; }
    .skill-icon.selected { border-color: var(--pragati-primary); background-color: #f0faf7; color: #1e6a53; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-4px); }
    
    .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Flippable Card Styles */
    .flip-card { perspective: 1000px; }
    .flip-card-inner { position: relative; width: 100%; min-height: 420px; transition: transform 0.6s; transform-style: preserve-3d; }
    .flip-card.is-flipped .flip-card-inner { transform: rotateY(180deg); }
    .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; }
    .flip-card-back { transform: rotateY(180deg); }
  </style>
</head>
<body class="font-sans">
  <div id="bg-video-container">
    <div id="video-overlay"></div>
    <video autoplay muted loop id="bg-video">
        <source src="WhatsApp Video 2025-08-24 at 18.15.23_303e5fcd.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
  </div>
  <div id="app" class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md p-4 border-b border-gray-200 sticky top-0 z-40">
      <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <video src="WhatsApp Video 2025-08-24 at 18.46.48_f0c28a93.mp4" alt="Pragati Logo" class="h-10 w-10 border border-green-500" autoplay loop muted></video>
          <h1 class="text-2xl font-bold text-gray-800">प्रगति | PRAGATI</h1>
        </div>
        <div id="header-actions" class="hidden items-center space-x-5">
          <button id="profileBtn" class="text-gray-500 hover:text-green-600 transition">
            <i class="fas fa-user-circle text-2xl"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto p-4 md:p-6 flex flex-col">
      <!-- Welcome/Login Screen -->
      <div id="loginScreen" class="max-w-md w-full mx-auto card my-auto">
        <div class="text-center mb-8">
        <video src="WhatsApp Video 2025-08-24 at 18.46.48_f0c28a93.mp4" alt="Pragati Logo" class="h-24 w-24 mx-auto mb-4 border-2 border-green-500 rounded-lg" autoplay loop muted></video>
          <h2 class="text-3xl font-bold text-gray-800">प्रगति | PRAGATI</h2>
          <p class="text-gray-600 mt-2 font-semibold text-lg">Right काम, Right Pay</p>
        </div>

        <div class="space-y-4 animate-fade-in">
            <button id="openAuthModalBtn" class="btn btn-primary w-full text-base py-3">Login or Register</button>
        </div>
      </div>

      <!-- Worker Dashboard -->
      <div id="workerDashboard" class="hidden w-full">
        <div class="card mb-6">
          <h2 class="text-2xl font-bold mb-6 flex items-center text-gray-800">
            <i class="fas fa-user-tie text-green-500 mr-3"></i>
            Worker Dashboard
          </h2>

          <div id="checkInSection">
            <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                <h3 class="text-lg font-semibold mb-2 text-green-800">Ready for your next job?</h3>
                <div class="flex items-center text-gray-600">
                  <i id="locationIcon" class="fas fa-map-marker-alt text-red-500 mr-2"></i>
                  <span id="locationStatus">Detecting your location...</span>
                </div>
            </div>

            <div class="mb-6">
              <p class="mb-3 font-semibold text-gray-700">Select your primary skill:</p>
              <div id="skillSelectionContainer" class="grid grid-cols-3 sm:grid-cols-4 gap-3">
                <!-- Skill Icons will be added by JS -->
              </div>
            </div>

            <button id="checkInBtn" class="btn btn-primary w-full text-lg py-3" disabled>
              <i class="fas fa-check-circle mr-2"></i>
              Check In & Be Visible
            </button>
          </div>

          <div id="checkedInSection" class="hidden">
             <div class="bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-md mb-6" role="alert">
              <p class="font-bold">You are checked in!</p>
              <p id="checkedInDetails" class="text-sm">You are now visible to nearby contractors.</p>
            </div>

            <div class="mb-6">
              <h3 class="text-xl font-semibold mb-4 text-gray-800">Available Jobs Nearby</h3>
              <div id="jobListWorker" class="space-y-4">
                <p class="text-gray-500 text-center py-4">No jobs posted in your area yet...</p>
              </div>
            </div>

            <button id="checkOutBtn" class="btn btn-danger w-full text-lg py-3">
              <i class="fas fa-sign-out-alt mr-2"></i>
              Check Out
            </button>
          </div>
        </div>
      </div>

       <!-- Contractor Dashboard -->
       <div id="contractorDashboard" class="hidden w-full">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="card">
                    <h2 class="text-2xl font-bold mb-4 flex items-center text-gray-800">
                        <i class="fas fa-bullhorn text-green-500 mr-3"></i>
                        Broadcast a Job
                    </h2>
                    <div class="mb-4">
                      <label for="jobDescription" class="block mb-2 font-semibold text-gray-700">Job Details</label>
                      <textarea id="jobDescription" class="form-input" rows="3" placeholder="e.g., Need 5 masons for a 3-day construction project."></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="jobPayment" class="block mb-2 font-semibold text-gray-700">Payment (per day)</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">₹</span>
                                <input type="number" id="jobPayment" class="form-input pl-8" placeholder="Amount">
                            </div>
                        </div>
                        <div>
                            <label for="jobTypeSelect" class="block mb-2 font-semibold text-gray-700">Job Type</label>
                            <select id="jobTypeSelect" class="form-input">
                                <option value="daily">Daily</option>
                                <option value="contract">Contract</option>
                                <option value="emergency">Emergency</option>
                            </select>
                        </div>
                    </div>
                    <button id="broadcastJobBtn" class="btn btn-primary w-full text-lg py-3">
                      Broadcast to Nearby Workers
                    </button>
                </div>
            </div>
            <div class="lg:col-span-1">
                <div class="card sticky top-24">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Available Workers</h3>
                    <div id="workerFilters" class="flex flex-wrap gap-2 mb-4">
                      <!-- Filter buttons will be added by JS -->
                    </div>
                    <div id="workerList" class="space-y-3 h-96 overflow-y-auto pr-2">
                      <p class="text-gray-500 text-center py-4">No workers available right now.</p>
                    </div>
                </div>
            </div>
          </div>
       </div>

       <!-- Jobs Screen -->
       <div id="jobsScreen" class="hidden w-full">
            <div class="card">
                <div class="flex items-center mb-6">
                    <button id="backFromJobsBtn" class="btn btn-secondary mr-4"><i class="fas fa-arrow-left"></i></button>
                    <h2 class="text-2xl font-bold flex items-center text-gray-800">
                        <i class="fas fa-briefcase text-green-500 mr-3"></i>
                        All Available Jobs
                    </h2>
                </div>
                <div id="jobListPublic" class="space-y-4">
                    <!-- Public job list will be rendered here -->
                </div>
            </div>
       </div>

       <!-- Profile Screen -->
       <div id="profileScreen" class="hidden w-full max-w-md mx-auto">
            <div class="card">
                <div class="flex items-center mb-6">
                     <button id="backFromProfileBtn" class="btn btn-secondary mr-4"><i class="fas fa-arrow-left"></i></button>
                     <h2 class="text-2xl font-bold text-gray-800">Profile</h2>
                </div>
                <div class="text-center">
                    <i class="fas fa-user-circle text-6xl mb-4 text-green-500"></i>
                    <h2 id="profileName" class="text-3xl font-bold mb-2 text-gray-800">User Name</h2>
                    <p id="profileType" class="text-green-600 capitalize mb-6">User Type</p>
                    <button id="logoutBtn" class="btn btn-danger w-full">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        Logout
                    </button>
                </div>
            </div>
       </div>

       <!-- Chatbot Screen -->
       <div id="chatbotScreen" class="hidden w-full">
            <div class="card flex flex-col h-[80vh]">
                <div class="flex items-center mb-4">
                    <button id="backFromChatbotBtn" class="btn btn-secondary mr-4"><i class="fas fa-arrow-left"></i></button>
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center"><i class="fas fa-robot text-green-500 mr-3"></i>AI Assistant</h2>
                </div>
                <div id="chatMessages" class="flex-grow bg-gray-100 rounded-lg p-4 overflow-y-auto space-y-4">
                    <!-- Chat messages will appear here -->
                </div>
                <div class="mt-4 flex">
                    <input type="text" id="chatInput" class="form-input flex-grow" placeholder="Ask for help with a small task...">
                    <button id="chatSendBtn" class="btn btn-primary ml-2"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
       </div>
    </main>

    <!-- Footer Navigation -->
    <footer id="footerNav" class="bg-white/80 backdrop-blur-md border-t border-gray-200 p-3 sticky bottom-0 hidden">
      <div class="container mx-auto">
        <div class="flex justify-around">
          <button id="homeBtn" class="nav-btn flex flex-col items-center text-green-600">
            <i class="fas fa-home text-xl"></i>
            <span class="text-xs font-semibold">Home</span>
          </button>
          <button id="jobsBtn" class="nav-btn flex flex-col items-center text-gray-500 hover:text-green-600">
            <i class="fas fa-briefcase text-xl"></i>
            <span class="text-xs">Jobs</span>
          </button>
          <button id="chatbotBtn" class="nav-btn flex flex-col items-center text-gray-500 hover:text-green-600">
            <i class="fas fa-robot text-xl"></i>
            <span class="text-xs">AI Help</span>
          </button>
          <button id="profileFooterBtn" class="nav-btn flex flex-col items-center text-gray-500 hover:text-green-600">
            <i class="fas fa-user-circle text-xl"></i>
            <span class="text-xs">Profile</span>
          </button>
        </div>
      </div>
    </footer>

    <!-- Unified Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden animate-fade-in">
        <div class="max-w-md w-full relative flip-card">
            <div class="flip-card-inner">
                <!-- Login Form (Front) -->
                <div class="flip-card-front card">
                    <button id="closeAuthModalBtnLogin" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times text-xl"></i></button>
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Login to your Account</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="loginNameInput" class="block mb-2 font-semibold text-gray-700">Your Name</label>
                            <input type="text" id="loginNameInput" class="form-input" placeholder="Enter your full name">
                        </div>
                        <button id="loginSubmitBtn" class="btn btn-primary w-full text-base py-3">Login</button>
                        <div class="relative flex py-2 items-center">
                            <div class="flex-grow border-t border-gray-300"></div>
                            <span class="flex-shrink mx-4 text-gray-500">OR</span>
                            <div class="flex-grow border-t border-gray-300"></div>
                        </div>
                        <button id="googleLoginBtn" class="btn btn-secondary w-full text-base py-3"><i class="fab fa-google mr-2"></i>Login with Google</button>
                        <p class="text-center text-sm text-gray-600">Don't have an account? <a href="#" id="showRegister" class="font-semibold text-green-600 hover:underline">Register</a></p>
                    </div>
                </div>
                <!-- Register Form (Back) -->
                <div class="flip-card-back card">
                    <button id="closeAuthModalBtnRegister" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times text-xl"></i></button>
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Create a New Account</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="registerNameInput" class="block mb-2 font-semibold text-gray-700">Your Name</label>
                            <input type="text" id="registerNameInput" class="form-input" placeholder="Enter your full name">
                        </div>
                        <div>
                            <label for="registerUserTypeSelect" class="block mb-2 font-semibold text-gray-700">I am a:</label>
                            <select id="registerUserTypeSelect" class="form-input">
                                <option value="worker">Worker</option>
                                <option value="contractor">Contractor</option>
                            </select>
                        </div>
                        <button id="registerSubmitBtn" class="btn btn-primary w-full text-base py-3">Register</button>
                        <p class="text-center text-sm text-gray-600">Already have an account? <a href="#" id="showLogin" class="font-semibold text-green-600 hover:underline">Login</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="text-white text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mb-4 mx-auto"></div>
            <p class="text-lg">Loading...</p>
        </div>
    </div>
    
    <script>
    // --- MOCK DATA ---
    const mockWorkers = [
        { _id: 'w1', name: "Ramesh Kumar", skill: "mason", distance: "0.5 km", rating: 4.5 },
        { _id: 'w2', name: "Suresh Singh", skill: "carpenter", distance: "1.2 km", rating: 4.2 },
        { _id: 'w3', name: "Mahesh Sahu", skill: "painter", distance: "2.1 km", rating: 4.7 },
        { _id: 'w4', name: "Ganesh Jena", skill: "plumber", distance: "0.8 km", rating: 4.0 },
        { _id: 'w5', name: "Dinesh Rout", skill: "mason", distance: "1.5 km", rating: 4.8 },
        { _id: 'w6', name: "Anil Pradhan", skill: "electrician", distance: "3.2 km", rating: 4.9 },
    ];

    const mockJobs = [
        { _id: 'j1', title: "Mason needed for wall", contractor: "ABC Constructions", payment: "₹800/day", type: "daily" },
        { _id: 'j2', title: "Urgent pipe repair", contractor: "Home Services Ltd.", payment: "₹1200", type: "emergency" },
        { _id: 'j3', title: "Full house painting contract", contractor: "Creative Painters", payment: "₹25000", type: "contract" },
    ];

    // --- APPLICATION LOGIC ---
    let appState = { currentUser: null, selectedSkill: null, workerLocation: null, previousScreen: null, currentScreen: 'login' };
    let chatHistory = [];
    
    const SKILLS = [
        { id: 'mason', name: 'Mason', icon: 'fa-hammer' },
        { id: 'carpenter', name: 'Carpenter', icon: 'fa-tools' },
        { id: 'painter', name: 'Painter', icon: 'fa-paint-roller' },
        { id: 'plumber', name: 'Plumber', icon: 'fa-faucet' },
        { id: 'electrician', name: 'Electrician', icon: 'fa-bolt' },
        { id: 'welder', name: 'Welder', icon: 'fa-fire' },
        { id: 'laborer', name: 'Laborer', icon: 'fa-people-carry' },
        { id: 'other', name: 'Other', icon: 'fa-ellipsis-h' },
    ];

    const DOMElements = {
        mainContent: document.querySelector('main'),
        loginScreen: document.getElementById('loginScreen'),
        workerDashboard: document.getElementById('workerDashboard'),
        contractorDashboard: document.getElementById('contractorDashboard'),
        jobsScreen: document.getElementById('jobsScreen'),
        profileScreen: document.getElementById('profileScreen'),
        chatbotScreen: document.getElementById('chatbotScreen'),
        
        authModal: document.getElementById('authModal'),
        openAuthModalBtn: document.getElementById('openAuthModalBtn'),
        closeAuthModalBtnLogin: document.getElementById('closeAuthModalBtnLogin'),
        closeAuthModalBtnRegister: document.getElementById('closeAuthModalBtnRegister'),
        flipCard: document.querySelector('.flip-card'),
        showRegister: document.getElementById('showRegister'),
        showLogin: document.getElementById('showLogin'),
        
        loginNameInput: document.getElementById('loginNameInput'),
        registerNameInput: document.getElementById('registerNameInput'),
        registerUserTypeSelect: document.getElementById('registerUserTypeSelect'),
        loginSubmitBtn: document.getElementById('loginSubmitBtn'),
        registerSubmitBtn: document.getElementById('registerSubmitBtn'),
        googleLoginBtn: document.getElementById('googleLoginBtn'),

        checkInBtn: document.getElementById('checkInBtn'),
        checkOutBtn: document.getElementById('checkOutBtn'),
        checkedInSection: document.getElementById('checkedInSection'),
        checkInSection: document.getElementById('checkInSection'),
        locationStatus: document.getElementById('locationStatus'),
        locationIcon: document.getElementById('locationIcon'),
        skillContainer: document.getElementById('skillSelectionContainer'),
        jobListWorker: document.getElementById('jobListWorker'),
        jobListPublic: document.getElementById('jobListPublic'),
        workerList: document.getElementById('workerList'),
        workerFilters: document.getElementById('workerFilters'),
        broadcastJobBtn: document.getElementById('broadcastJobBtn'),
        jobDescription: document.getElementById('jobDescription'),
        jobPayment: document.getElementById('jobPayment'),
        jobTypeSelect: document.getElementById('jobTypeSelect'),
        loadingSpinner: document.getElementById('loadingSpinner'),
        headerActions: document.getElementById('header-actions'),
        footerNav: document.getElementById('footerNav'),
        homeBtn: document.getElementById('homeBtn'),
        jobsBtn: document.getElementById('jobsBtn'),
        profileBtn: document.getElementById('profileBtn'),
        profileFooterBtn: document.getElementById('profileFooterBtn'),
        profileName: document.getElementById('profileName'),
        profileType: document.getElementById('profileType'),
        logoutBtn: document.getElementById('logoutBtn'),
        backFromJobsBtn: document.getElementById('backFromJobsBtn'),
        backFromProfileBtn: document.getElementById('backFromProfileBtn'),
        chatbotBtn: document.getElementById('chatbotBtn'),
        backFromChatbotBtn: document.getElementById('backFromChatbotBtn'),
        chatMessages: document.getElementById('chatMessages'),
        chatInput: document.getElementById('chatInput'),
        chatSendBtn: document.getElementById('chatSendBtn'),
    };

    function initApp() {
        const storedUser = localStorage.getItem('pragatiUser');
        if (storedUser) {
            appState.currentUser = JSON.parse(storedUser);
            showScreen(appState.currentUser.userType);
        } else {
            showScreen('login');
        }
        setupEventListeners();
        populateSkills();
        populateWorkerFilters();
    }

    function showScreen(screenName) {
        appState.previousScreen = appState.currentScreen;
        appState.currentScreen = screenName;

        [DOMElements.loginScreen, DOMElements.workerDashboard, DOMElements.contractorDashboard, DOMElements.jobsScreen, DOMElements.profileScreen, DOMElements.chatbotScreen].forEach(el => el.classList.add('hidden'));
        DOMElements.headerActions.classList.add('hidden');
        DOMElements.footerNav.classList.add('hidden');
        DOMElements.mainContent.classList.remove('items-center', 'justify-center');
        DOMElements.mainContent.classList.add('items-start');

        updateActiveNav(screenName);

        if (screenName === 'login') {
            DOMElements.mainContent.classList.add('items-center', 'justify-center');
            DOMElements.loginScreen.classList.remove('hidden');
        } else {
            DOMElements.headerActions.classList.remove('hidden');
            DOMElements.footerNav.classList.remove('hidden');
            if (screenName === 'worker') {
                DOMElements.workerDashboard.classList.remove('hidden');
                getWorkerLocation();
                renderJobList(mockJobs, DOMElements.jobListWorker);
            } else if (screenName === 'contractor') {
                DOMElements.contractorDashboard.classList.remove('hidden');
                findWorkers('all');
            } else if (screenName === 'jobs') {
                DOMElements.jobsScreen.classList.remove('hidden');
                renderJobList(mockJobs, DOMElements.jobListPublic);
            } else if (screenName === 'profile') {
                DOMElements.mainContent.classList.add('items-center');
                DOMElements.profileScreen.classList.remove('hidden');
                renderProfile();
            } else if (screenName === 'chatbot') {
                DOMElements.chatbotScreen.classList.remove('hidden');
            }
        }
    }

    async function handleLogin() {
        const name = DOMElements.loginNameInput.value;
        if (!name) { alert('Please enter your name.'); return; }
        
        showLoading();
        await new Promise(res => setTimeout(res, 1000));
        
        const user = { _id: `user_${Date.now()}`, name, userType: 'worker' };
        appState.currentUser = user;
        localStorage.setItem('pragatiUser', JSON.stringify(user));
        
        closeModal(DOMElements.authModal);
        showScreen(user.userType);
        hideLoading();
    }

    async function handleRegister() {
        const name = DOMElements.registerNameInput.value;
        const userType = DOMElements.registerUserTypeSelect.value;
        if (!name) { alert('Please enter your name.'); return; }

        showLoading();
        await new Promise(res => setTimeout(res, 1000));
        
        const user = { _id: `user_${Date.now()}`, name, userType };
        appState.currentUser = user;
        localStorage.setItem('pragatiUser', JSON.stringify(user));

        closeModal(DOMElements.authModal);
        showScreen(user.userType);
        hideLoading();
    }

    async function handleGoogleLogin() {
        showLoading();
        await new Promise(res => setTimeout(res, 1000));
        
        const user = { _id: `user_${Date.now()}`, name: "Google User", userType: 'worker' };
        appState.currentUser = user;
        localStorage.setItem('pragatiUser', JSON.stringify(user));

        closeModal(DOMElements.authModal);
        showScreen(user.userType);
        hideLoading();
    }

    function handleLogout() {
        localStorage.removeItem('pragatiUser');
        appState.currentUser = null;
        showScreen('login');
    }

    function setupEventListeners() {
        DOMElements.openAuthModalBtn.addEventListener('click', () => openModal(DOMElements.authModal));
        const closeAuthModal = () => closeModal(DOMElements.authModal);
        DOMElements.closeAuthModalBtnLogin.addEventListener('click', closeAuthModal);
        DOMElements.closeAuthModalBtnRegister.addEventListener('click', closeAuthModal);
        DOMElements.authModal.addEventListener('click', (e) => { if(e.target === DOMElements.authModal) closeAuthModal(); });
        
        DOMElements.showRegister.addEventListener('click', (e) => {
            e.preventDefault();
            DOMElements.flipCard.classList.add('is-flipped');
        });
        DOMElements.showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            DOMElements.flipCard.classList.remove('is-flipped');
        });

        DOMElements.loginSubmitBtn.addEventListener('click', handleLogin);
        DOMElements.registerSubmitBtn.addEventListener('click', handleRegister);
        DOMElements.googleLoginBtn.addEventListener('click', handleGoogleLogin);
        DOMElements.checkInBtn.addEventListener('click', handleCheckIn);
        DOMElements.checkOutBtn.addEventListener('click', handleCheckOut);
        DOMElements.broadcastJobBtn.addEventListener('click', handleBroadcastJob);
        DOMElements.logoutBtn.addEventListener('click', handleLogout);

        const backToDashboard = () => showScreen(appState.previousScreen || appState.currentUser.userType);
        DOMElements.homeBtn.addEventListener('click', () => showScreen(appState.currentUser.userType));
        DOMElements.backFromJobsBtn.addEventListener('click', backToDashboard);
        DOMElements.backFromProfileBtn.addEventListener('click', backToDashboard);
        DOMElements.backFromChatbotBtn.addEventListener('click', backToDashboard);

        DOMElements.jobsBtn.addEventListener('click', () => showScreen('jobs'));
        DOMElements.profileBtn.addEventListener('click', () => showScreen('profile'));
        DOMElements.profileFooterBtn.addEventListener('click', () => showScreen('profile'));
        DOMElements.chatbotBtn.addEventListener('click', () => showScreen('chatbot'));
        DOMElements.chatSendBtn.addEventListener('click', sendMessage);
        DOMElements.chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    }
    
    function openModal(modal) {
        modal.classList.remove('hidden');
    }

    function closeModal(modal) {
        modal.classList.add('hidden');
        if (modal === DOMElements.authModal) {
            DOMElements.flipCard.classList.remove('is-flipped');
        }
    }

    function updateActiveNav(screenName) {
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('text-green-600');
            btn.classList.add('text-gray-500');
        });

        if (screenName === 'worker' || screenName === 'contractor') {
            DOMElements.homeBtn.classList.add('text-green-600');
            DOMElements.homeBtn.classList.remove('text-gray-500');
        } else if (screenName === 'jobs') {
            DOMElements.jobsBtn.classList.add('text-green-600');
            DOMElements.jobsBtn.classList.remove('text-gray-500');
        } else if (screenName === 'profile') {
            DOMElements.profileFooterBtn.classList.add('text-green-600');
            DOMElements.profileFooterBtn.classList.remove('text-gray-500');
        } else if (screenName === 'chatbot') {
            DOMElements.chatbotBtn.classList.add('text-green-600');
            DOMElements.chatbotBtn.classList.remove('text-gray-500');
        }
    }

    function populateSkills() {
        DOMElements.skillContainer.innerHTML = '';
        SKILLS.forEach(skill => {
            const div = document.createElement('div');
            div.className = 'skill-icon p-3 rounded-lg border text-center cursor-pointer text-gray-800';
            div.dataset.skill = skill.id;
            div.innerHTML = `<i class="fas ${skill.icon} text-3xl mb-2 text-green-500"></i><p class="text-sm font-semibold">${skill.name}</p>`;
            div.addEventListener('click', () => {
                document.querySelectorAll('.skill-icon').forEach(i => { i.classList.remove('selected'); });
                div.classList.add('selected');
                appState.selectedSkill = skill.id;
                DOMElements.checkInBtn.disabled = !appState.workerLocation;
            });
            DOMElements.skillContainer.appendChild(div);
        });
    }

    function getWorkerLocation() {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                appState.workerLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                DOMElements.locationStatus.textContent = 'Location detected successfully!';
                DOMElements.locationIcon.classList.remove('animate-pulse', 'text-red-500');
                DOMElements.locationIcon.classList.add('text-green-500');
                if (appState.selectedSkill) DOMElements.checkInBtn.disabled = false;
            },
            () => {
                DOMElements.locationStatus.textContent = 'Location access denied.';
                DOMElements.locationIcon.classList.remove('animate-pulse');
            }
        );
    }
    
    function handleCheckIn() {
        if (!appState.selectedSkill || !appState.workerLocation) { alert('Please select a skill and enable location.'); return; }
        showLoading();
        setTimeout(() => {
            DOMElements.checkInSection.classList.add('hidden');
            DOMElements.checkedInSection.classList.remove('hidden');
            hideLoading();
        }, 500);
    }

    function handleCheckOut() {
        showLoading();
        setTimeout(() => {
            DOMElements.checkedInSection.classList.add('hidden');
            DOMElements.checkInSection.classList.remove('hidden');
            hideLoading();
        }, 500);
    }

    function renderJobList(jobs, container) {
        container.innerHTML = '';
        if (!jobs || jobs.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">No jobs available right now.</p>';
            return;
        }
        jobs.forEach(job => {
            const jobEl = document.createElement('div');
            jobEl.className = 'bg-white/90 p-4 rounded-lg border border-gray-200 shadow-sm';
            jobEl.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-semibold text-lg text-gray-800">${job.title}</h4>
                    <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800">${job.type}</span>
                </div>
                <p class="text-sm text-gray-600 mb-3">Posted by: ${job.contractor}</p>
                <div class="flex justify-between items-center text-sm">
                    <span class="font-semibold text-green-600 text-lg">${job.payment}</span>
                    <button class="btn btn-secondary text-xs py-1 px-3">View Details</button>
                </div>`;
            container.appendChild(jobEl);
        });
    }
    
    function renderProfile() {
        if (appState.currentUser) {
            DOMElements.profileName.textContent = appState.currentUser.name;
            DOMElements.profileType.textContent = appState.currentUser.userType;
        }
    }

    function populateWorkerFilters() {
        DOMElements.workerFilters.innerHTML = '';
        const allBtn = document.createElement('button');
        allBtn.className = 'worker-filter px-3 py-1 rounded-full bg-green-600 text-white text-sm';
        allBtn.dataset.skill = 'all';
        allBtn.textContent = 'All';
        allBtn.addEventListener('click', (e) => filterAndRenderWorkers(e.target));
        DOMElements.workerFilters.appendChild(allBtn);

        SKILLS.forEach(skill => {
            const btn = document.createElement('button');
            btn.className = 'worker-filter px-3 py-1 rounded-full bg-gray-200 text-gray-800 text-sm';
            btn.dataset.skill = skill.id;
            btn.innerHTML = `<i class="fas ${skill.icon} mr-1"></i> ${skill.name}`;
            btn.addEventListener('click', (e) => filterAndRenderWorkers(e.target));
            DOMElements.workerFilters.appendChild(btn);
        });
    }

    function filterAndRenderWorkers(clickedButton) {
        document.querySelectorAll('.worker-filter').forEach(btn => {
            btn.classList.remove('bg-green-600', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-800');
        });
        clickedButton.classList.add('bg-green-600', 'text-white');
        clickedButton.classList.remove('bg-gray-200', 'text-gray-800');
        findWorkers(clickedButton.dataset.skill);
    }

    async function findWorkers(skill = 'all') {
        showLoading();
        await new Promise(res => setTimeout(res, 500));
        const filtered = skill === 'all' ? mockWorkers : mockWorkers.filter(w => w.skill === skill);
        renderWorkerList(filtered);
        hideLoading();
    }
    
    function renderWorkerList(workers) {
        DOMElements.workerList.innerHTML = '';
        if (workers.length === 0) {
            DOMElements.workerList.innerHTML = '<p class="text-gray-500 text-center py-4">No workers found.</p>';
            return;
        }
        workers.forEach(worker => {
            const skillInfo = SKILLS.find(s => s.id === worker.skill) || { name: 'Worker', icon: 'fa-user-tie' };
            const workerEl = document.createElement('div');
            workerEl.className = 'bg-white p-3 rounded-lg flex items-center border border-gray-200 shadow-sm';
            workerEl.innerHTML = `
                <div class="mr-4 text-2xl w-8 text-center"><i class="fas ${skillInfo.icon} text-green-500"></i></div>
                <div class="flex-grow">
                    <h4 class="font-semibold text-gray-800">${worker.name}</h4>
                    <p class="text-sm text-gray-600">${skillInfo.name} • <span class="font-semibold">${worker.distance}</span></p>
                </div>
                <div class="flex flex-col items-end space-y-1 w-32">
                    <div class="flex items-center justify-end text-yellow-500">
                        <span class="font-bold">${worker.rating}</span>
                        <i class="fas fa-star ml-1"></i>
                    </div>
                    <div class="flex flex-wrap gap-1 justify-end">
                        <button class="btn btn-secondary text-xs py-1 px-2 hover:bg-green-100 hover:text-green-700 transition"><i class="fas fa-phone-alt mr-1"></i>Call</button>
                        <button class="btn btn-secondary text-xs py-1 px-2 hover:bg-green-100 hover:text-green-700 transition"><i class="fas fa-bell mr-1"></i>Notify</button>
                        <button class="btn btn-secondary text-xs py-1 px-2 hover:bg-green-100 hover:text-green-700 transition"><i class="fas fa-comment-alt mr-1"></i>Message</button>
                    </div>
                </div>
            `;
            DOMElements.workerList.appendChild(workerEl);
        });
    }
    
    function handleBroadcastJob() {
        if (!DOMElements.jobDescription.value || !DOMElements.jobPayment.value) {
            alert('Please fill in all job details.');
            return;
        }
        showLoading();
        setTimeout(() => {
            alert('Job has been broadcasted to nearby workers!');
            DOMElements.jobDescription.value = '';
            DOMElements.jobPayment.value = '';
            hideLoading();
        }, 1000);
    }
    
    // --- CHATBOT FUNCTIONS ---
    function addMessageToChat(sender, message) {
        const messageElement = document.createElement('div');
        let formattedMessage = message.replace(/\n/g, '<br>');

        if (sender === 'user') {
            messageElement.className = 'bg-green-500 text-white p-3 rounded-lg self-end max-w-xs md:max-w-md ml-auto';
        } else { // AI
            messageElement.className = 'bg-gray-200 text-gray-800 p-3 rounded-lg self-start max-w-xs md:max-w-md';
        }
        messageElement.innerHTML = formattedMessage;
        DOMElements.chatMessages.appendChild(messageElement);
        DOMElements.chatMessages.scrollTop = DOMElements.chatMessages.scrollHeight;
    }

    async function sendMessage() {
        const userInput = DOMElements.chatInput.value.trim();
        if (!userInput) return;

        addMessageToChat('user', userInput);
        DOMElements.chatInput.value = '';
        
        const thinkingIndicator = document.createElement('div');
        thinkingIndicator.className = 'bg-gray-200 text-gray-500 p-3 rounded-lg self-start';
        thinkingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Thinking...';
        DOMElements.chatMessages.appendChild(thinkingIndicator);
        DOMElements.chatMessages.scrollTop = DOMElements.chatMessages.scrollHeight;

        try {
            const aiResponse = await sendMessageToGemini(userInput);
            DOMElements.chatMessages.removeChild(thinkingIndicator);
            addMessageToChat('ai', aiResponse);
        } catch (error) {
            console.error("Gemini API Error:", error);
            DOMElements.chatMessages.removeChild(thinkingIndicator);
            addMessageToChat('ai', "Sorry, I'm having trouble connecting. Please try again later.");
        }
    }

    async function sendMessageToGemini(prompt) {
        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
        const payload = { contents: chatHistory };
        const apiKey = ""; // This will be handled by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
  
        if (!response.ok) {
            throw new Error(`API request failed with status ${response.status}`);
        }

        const result = await response.json();
        const text = result.candidates[0].content.parts[0].text;
        chatHistory.push({ role: "model", parts: [{ text: text }] });
        return text;
    }

    function showLoading() { DOMElements.loadingSpinner.classList.remove('hidden'); }
    function hideLoading() { DOMElements.loadingSpinner.classList.add('hidden'); }

    document.addEventListener('DOMContentLoaded', initApp);
    </script>
  </div>
</body>
</html>

